CREATE TABLE user_transactions (
    transaction_id int,
    user_id int,
    amount float,
    transaction_date datetime
);

INSERT INTO user_transactions (transaction_id, user_id, amount, transaction_date)
VALUES
    (1, 1, 0.21, '2021-01-01 15:10:10'),
    (2, 1, 0.37, '2021-01-01 15:10:10'),
    (3, 1, 1.21, '2021-01-02 15:10:10'),
    (4, 1, 0.73, '2021-01-02 15:10:10'),
    (5, 1, 0.11, '2021-01-03 15:10:10'),
    (6, 1, 1.31, '2021-01-03 15:10:10'),
    (7, 1, 2.13, '2021-01-04 15:10:10'),
    (2, 1, 0.37, '2021-01-05 15:10:10'),
    (3, 1, 1.21, '2021-01-05 15:10:10'),
    (4, 1, 40.73, '2021-01-06 15:10:10'),
    (5, 1, 0.11, '2021-01-07 15:10:10'),
    (6, 1, 11.31, '2021-01-08 15:10:10'),
    (7, 1, 2.13, '2021-01-08 15:10:10'),
    (2, 1, 0.37, '2021-01-08 15:10:10'),
    (3, 1, 71.21, '2021-01-09 15:10:10'),
    (4, 1, 0.73, '2021-01-10 15:10:10'),
    (5, 1, 9.11, '2021-01-10 15:10:10'),
    (6, 1, 1.31, '2021-01-11 15:10:10'),
    (7, 1, 3.13, '2021-01-12 15:10:10'),
    (2, 1, 0.37, '2021-01-13 15:10:10'),
    (3, 1, 1.21, '2021-01-14 15:10:10'),
    (4, 1, 0.73, '2021-01-14 15:10:10'),
    (5, 1, 0.11, '2021-01-15 15:10:10'),
    (6, 1, 1.31, '2021-01-16 15:10:10');
    
WITH daily_transactions AS (
    SELECT 
        CAST(transaction_date AS DATE) AS transaction_date,
        SUM(amount) AS total_amount
    FROM
        user_transactions
    GROUP BY
        transaction_date
)

SELECT 
    transaction_date,
    total_amount,
    AVG(total_amount) OVER (
        ORDER BY transaction_date
        ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
    ) AS weekly_rolling_avg
FROM
    daily_transactions;
    
/*
+------------------+---------------------+--------------------+
| transaction_date | total_amount        | weekly_rolling_avg |
+------------------+---------------------+--------------------+
| 2021-01-01       |  0.5799999982118607 | 0.5799999982118607 |
| 2021-01-02       |   1.940000057220459 | 1.2600000277161598 |
| 2021-01-03       |  1.4199999421834946 | 1.3133333325386047 |
| 2021-01-04       |   2.130000114440918 |  1.517500028014183 |
| 2021-01-05       |  1.5800000429153442 | 1.5300000309944153 |
| 2021-01-06       |   40.72999954223633 |  8.063333282868067 |
| 2021-01-07       | 0.10999999940395355 |  6.927142813801765 |
| 2021-01-08       |  13.810000538825989 |  8.817142891032356 |
| 2021-01-09       |   71.20999908447266 |  18.71285703778267 |
| 2021-01-10       |   9.839999675750732 |  19.91571414257799 |
| 2021-01-11       |   1.309999942779541 | 19.798571260912077 |
| 2021-01-12       |   3.130000114440918 | 20.019999842558587 |
| 2021-01-13       |  0.3700000047683716 | 14.254285622920309 |
| 2021-01-14       |   1.940000057220459 |  14.51571420260838 |
| 2021-01-15       | 0.10999999940395355 | 12.558571268405233 |
| 2021-01-16       |   1.309999942779541 | 2.5728571053062166 |
+------------------+---------------------+--------------------+
16 rows in set, 1 warning (0.00 sec)
*/
